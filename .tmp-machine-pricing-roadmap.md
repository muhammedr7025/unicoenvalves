# Machine Pricing Implementation Roadmap

## âœ… COMPLETED - Step 1: Type Definitions
- Added `MachineType` interface
- Added `ComponentType` type
- Added `WorkHourData` interface
- Updated `QuoteProduct` with:
  - `trimType` field
  - Machine cost fields for each component (Body, Bonnet, Plug, Seat, Stem, Cage, SealRing)
  - Fields include: workHours, machineTypeId, machineTypeName, machineRate, machineCost

---

## ðŸ”„ NEXT STEPS

### Step 2: Firebase Service Layer
**File:** `lib/firebase/machinePricingService.ts` (NEW)

Functions needed:
1. **Machine Types CRUD:**
   - `getMachineTypes()` - Get all active machine types
   - `getMachineTypeById(id)` - Get single machine type
   - `addMachineType(data)` - Add new machine type
   - `updateMachineType(id, data)` - Update machine type
   - `deleteMachineType(id)` - Soft delete (set isActive = false)

2. **Work Hours CRUD:**
   - `getWorkHours()` - Get all work hour data
   - `getWorkHoursByComponent(component)` - Filter by component
   - `getWorkHourData(seriesId, size, rating, component, trimType?)` - Lookup specific work hour
   - `addWorkHourData(data)` - Add new work hour entry
   - `updateWorkHourData(id, data)` - Update work hour entry
   - `deleteWorkHourData(id)` - Soft delete
   - `bulkImportWorkHours(data[])` - Bulk import from Excel

3. **Excel Import/Export:**
   - `importMachinePricingFromExcel(file)` - Parse and import Excel
   - `exportMachinePricingToExcel()` - Generate Excel template

### Step 3: Update Product Config Helper
**File:** `lib/firebase/productConfigHelper.ts`

Add new functions:
1. `getAvailableTrimTypes()` - Get list of trim types
2. `getWorkHourForBody(seriesId, size, rating)` - Get body work hours
3. `getWorkHourForBonnet(seriesId, size, rating)` - Get bonnet work hours
4. `getWorkHourForPlug(seriesId, size, rating, trimType)` - Get plug work hours
5. `getWorkHourForSeat(seriesId, size, rating, trimType)` - Get seat work hours
6. `getWorkHourForStem(seriesId, size, rating, trimType)` - Get stem work hours
7. `getWorkHourForCage(seriesId, size, rating, trimType)` - Get cage work hours
8. `getWorkHourForSealRing(seriesId, size, rating, trimType)` - Get seal ring work hours

### Step 4: Update useProductConfig Hook
**File:** `hooks/useProductConfig.ts`

Changes:
1. Add `availableTrimTypes` state
2. Load trim types in `useEffect`
3. Update `calculateProductPrice()` to:
   - Fetch work hour data for each component
   - Calculate machine cost = workHours Ã— machineRate
   - Add machine cost to component totalCost
   - Update bodySubAssemblyTotal to include machine costs

### Step 5: Update Product Configuration Form
**File:** `components/quotes/ProductConfigurationForm.tsx`

Changes:
1. Add Trim Type dropdown field (after Product Tag, before Series)
2. Update price summary to show material + machine costs separately:
   ```
   Body:
     Material: â‚¹X (Ykg Ã— â‚¹Z/kg)
     Machine: â‚¹A (Bhr Ã— â‚¹C/hr - <Machine Name>)
     Total: â‚¹(X+A)
   ```

### Step 6: Admin - Machine Pricing Page
**File:** `app/admin/machine-pricing/page.tsx` (NEW)

Features:
1. **Tab 1: Machine Types**
   - Table showing all machine types
   - Add/Edit/Delete functionality
   - Columns: Name, Hourly Rate, Status

2. **Tab 2: Work Hours Data**
   - Table showing all work hour data
   - Filter by component type
   - Search functionality
   - Columns: Component, Series, Size, Rating, Trim Type, Work Hours, Machine Type

3. **Import/Export Section**
   - Upload Excel button
   - Download Template button
   - Import status/errors display

### Step 7: Excel Template Generator
**File:** `utils/machinePricingExcel.ts` (NEW)

Generate Excel with sheets:
1. **Machine Types** - Name, Hourly Rate
2. **Body Work Hours** - Series, Size, Rating, Work Hours, Machine Type Name
3. **Bonnet Work Hours** - Series, Size, Rating, Work Hours, Machine Type Name
4. **Plug Work Hours** - Series, Size, Rating, Trim Type, Work Hours, Machine Type Name
5. **Seat Work Hours** - Series, Size, Rating, Trim Type, Work Hours, Machine Type Name
6. **Stem Work Hours** - Series, Size, Rating, Trim Type, Work Hours, Machine Type Name
7. **Cage Work Hours** - Series, Size, Rating, Trim Type, Work Hours, Machine Type Name
8. **Seal Ring Work Hours** - Series, Size, Rating, Trim Type, Work Hours, Machine Type Name

### Step 8: Update Existing Quote Pages
**Files:** 
- `app/employee/edit-quote/[id]/page.tsx`
- `app/employee/new-quote/page.tsx`

Changes:
- Ensure machine costs are displayed in quote reviews
- Update quote PDF generation to include machine costs

### Step 9: Testing Checklist
- [ ] Machine types CRUD operations
- [ ] Work hours CRUD operations
- [ ] Excel import/export
- [ ] Trim type selection
- [ ] Machine cost calculation for all components
- [ ] Price summary display
- [ ] Quote creation with machine costs
- [ ] Quote editing with machine costs

---

## ðŸ“Š Database Structure

### Collection: `machineTypes`
```
{
  id: "auto-generated",
  name: "CNC Lathe",
  hourlyRate: 500,
  isActive: true
}
```

### Collection: `workHours`
```
{
  id: "auto-generated",
  seriesId: "series-123",
  size: "2\"",
  rating: "150#",
  trimType: "Metal Seated",  // null for Body, Bonnet
  component: "Plug",
  workHours: 2.5,
  machineTypeId: "machine-123",
  machineTypeName: "CNC Lathe",  // denormalized
  isActive: true
}
```

### Collection: `trimTypes` (Optional - or hardcoded list)
```
{
  id: "auto-generated",
  name: "Metal Seated",
  isActive: true
}
```

---

## ðŸŽ¯ Current Status
âœ… Step 1: Type Definitions - COMPLETED

Ready to proceed with Step 2: Firebase Service Layer?
