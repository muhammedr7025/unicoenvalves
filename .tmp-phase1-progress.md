# Machine Pricing - Phase 1 Progress Report

## ‚úÖ COMPLETED

### Step 1: Type Definitions ‚úÖ
**File:** `types/index.ts`
- Added `MachineType` interface
- Added `ComponentType` type ('Body' | 'Bonnet' | 'Plug' | 'Seat' | 'Stem' | 'Cage' | 'SealRing')
- Added `WorkHourData` interface
- Updated `QuoteProduct` with:
  - `trimType?` field
  - Machine cost fields for all 7 components:
    - `bodyWorkHours`, `bodyMachineTypeId`, `bodyMachineTypeName`, `body MachineRate`, `bodyMachineCost`
    - Same pattern for: Bonnet, Plug, Seat, Stem, Cage, SealRing

### Step 2: Firebase Service Layer ‚úÖ
**File:** `lib/firebase/machinePricingService.ts` (NEW)

**Machine Types CRUD:**
- `getMachineTypes()` - Get all active machine types
- `getMachineTypeById(id)` - Get single machine type
- `addMachineType(data)` - Add new machine type
- `updateMachineType(id, data)` - Update machine type
- `deleteMachineType(id)` - Soft delete

**Work Hours CRUD:**
- `getWorkHours()` - Get all work hour data
- `getWorkHoursByComponent(component)` - Filter by component
- `getWorkHourData(seriesId, size, rating, component, trimType?)` - Lookup specific work hour
  - Handles Body/Bonnet (no trimType) vs other components (requires trimType)
- `addWorkHourData(data)` - Add new work hour entry
- `updateWorkHourData(id, data)` - Update work hour entry
- `deleteWorkHourData(id)` - Soft delete
- `bulkImportWorkHours(data[])` - Bulk import
- `bulkImportMachineTypes(data[])` - Bulk import

**Trim Types:**
- `getAvailableTrimTypes()` - Returns hardcoded list (Phase 1)

### Step  3: Product Config Helper Updates ‚úÖ
**File:** `lib/firebase/productConfigHelper.ts`

Added machine pricing helper functions:
- `getAvailableTrimTypes()` - Get list of trim types
- `getWorkHourForBody(seriesId, size, rating)` - Body work hours (no trim type)
- `getWorkHourForBonnet(seriesId, size, rating)` - Bonnet work hours (no trim type)
- `getWorkHourForPlug(seriesId, size, rating, trimType)` - Plug work hours (requires trim type)
- `getWorkHourForSeat(seriesId, size, rating, trimType)` - Seat work hours (requires trim type)
- `getWorkHourForStem(seriesId, size, rating, trimType)` - Stem work hours (requires trim type)
- `getWorkHourForCage(seriesId, size, rating, trimType)` - Cage work hours (requires trim type)
- `getWorkHourForSealRing(seriesId, size, rating, trimType)` - Seal Ring work hours (requires trim type)

All functions return `WorkHourResult | null` containing:
- `workHours`: number
- `machineTypeId`: string
- `machineTypeName`: string
- `machineRate`: number (‚Çπ/hour)

---

## üîÑ NEXT IN PHASE 1

### Step 4: Update useProductConfig Hook
**File:** `hooks/useProductConfig.ts`

Need to:
1. Add `availableTrimTypes` state
2. Load trim types in `useEffect`
3. Update `calculateProductPrice()` to:
   - Validate trimType is selected (for applicable components)
   - Fetch work hour data for each component
   - Calculate machine cost = workHours √ó machineRate
   - Add machine cost to each component's totalCost
   - Update bodySubAssemblyTotal formula to include machine costs
   - Update logs to show machine cost calculations

### Step 5: Update Product Configuration Form
**File:** `components/quotes/ProductConfigurationForm.tsx`

Need to:
1. Add Trim Type dropdown field:
   - Position: After Product Tag, before Series selection
   - Required field with validation
   - Yellow/orange background to indicate importance
2. Update price summary to show:
   ```
   Body:
     Material: ‚ÇπX (Ykg √ó ‚ÇπZ/kg)
     Machine: ‚ÇπA (Bhr √ó ‚ÇπC/hr - <Machine Name>)
     Total: ‚Çπ(X+A)
   ```
   Same for all components

---

## üìä Database Collections Needed

These collections need to exist in Firestore:

### `machineTypes`
```json
{
  "id": "auto-generated",
  "name": "CNC Lathe",
  "hourlyRate": 500,
  "isActive": true
}
```

### `workHours`
```json
{
  "id": "auto-generated",
  "seriesId": "series-123",
  "size": "2\"",
  "rating": "150#",
  "trimType": "Metal Seated",  // null for Body, Bonnet
  "component": "Plug",
  "workHours": 2.5,
  "machineTypeId": "machine-123",
  "machineTypeName": "CNC Lathe",
  "isActive": true
}
```

---

## üéØ Phase 1 Status: 60% Complete

- ‚úÖ Step 1: Type Definitions
- ‚úÖ Step 2: Firebase Service Layer
- ‚úÖ Step 3: Product Config Helper
- ‚è≥ Step 4: useProductConfig Hook (NEXT)
- ‚è≥ Step 5: Product Configuration Form

After Phase 1 is complete, pricing calculations will work end-to-end!

---

## ‚ö†Ô∏è Important Notes

1. **Trim Type** - Required for: Plug, Seat, Stem, Cage, Seal Ring
2. **No Trim Type** - For: Body, Bonnet
3. **Machine Cost** - Added to manufacturing cost (not bought-out)
4. **Formula**: Total Component Cost = Material Cost + Machine Cost
5. **Manufacturing Cost** = Sum of all component costs (material + machine)

---

## üöÄ Ready to Continue?

Say "continue" to proceed with Steps 4 & 5 to complete Phase 1!
